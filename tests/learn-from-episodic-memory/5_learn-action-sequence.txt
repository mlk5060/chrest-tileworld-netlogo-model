<test>
	repeat 50[
		;=========================;
		;== SETUP CHREST TURTLE ==;
		;=========================;

		; None of the CHREST turtle's parameters matter in this test.  They're just
		; set to appease the variable checker in the model code.

		create-chrest-turtles 1[
			set add-production-time (1)
			set can-create-semantic-links? (true)
			set can-create-templates? (true)
			set can-plan? (true)
			set can-use-pattern-recognition? (true)
			set discount-rate (0.5)
			set discrimination-time (1)
			set familiarisation-time (1)
			set initial-fixation-threshold (1)
			set ltm-link-traversal-time (1)
			set max-fixations-in-set (5)
			set max-search-iteration (3)
			set maximum-semantic-link-search-distance (3)
			set minimum-depth-of-node-in-network-to-be-a-template (3)
			set minimum-item-or-position-occurrences-in-node-images-to-be-a-slot-value (3)
			set node-comparison-time (1)
			set node-image-similarity-threshold (2)
			set peripheral-item-fixation-max-attempts (3)
			set play-time (1400000)
			set probability-of-using-problem-solving (0.0)
			set recognised-visual-spatial-field-object-lifespan (1)
			set reinforce-production-time (1)
			set reinforcement-learning-theory ("profit_sharing_with_discount_rate")
			set rho (1.0)
			set saccade-time (1)
			set sight-radius (2)
			set time-taken-to-decide-upon-ahead-of-agent-fixations (1)
			set time-taken-to-decide-upon-movement-fixations (1)
			set time-taken-to-decide-upon-peripheral-item-fixations (1)
			set time-taken-to-decide-upon-peripheral-square-fixations (1)
			set time-taken-to-decide-upon-salient-object-fixations (1)
			set time-taken-to-move (1)
			set time-taken-to-push-tile (1)
			set time-to-access-visual-spatial-field (1)
			set time-to-create-semantic-link (1)
			set time-to-encode-recognised-scene-object-as-visual-spatial-field-object (1)
			set time-to-encode-unrecognised-empty-square-scene-object-as-visual-spatial-field-object (1)
			set time-to-encode-unrecognised-non-empty-square-scene-object-as-visual-spatial-field-object (1)
			set time-to-generate-action-when-no-tile-seen (1)
			set time-to-generate-action-when-tile-seen (1)
			set time-to-move-visual-spatial-field-object (1)
			set time-to-process-unrecognised-scene-object-during-visual-spatial-field-construction (1)
			set time-to-retrieve-fixation-from-perceiver (1)
			set time-to-retrieve-item-from-stm (1)
			set time-to-update-stm (1)
			set training-time (0)
			set unknown-visual-spatial-field-object-replacement-probabilities (list (list 1.0 blind-patch-token))
			set unrecognised-visual-spatial-field-object-lifespan (1)
		]
		setup(true)

		ask turtle 0[

			;================================;
			;== POPULATE 'episodic-memory' ==;
			;================================;

			;;; EPISODE 1 ;;;

			let episode-1-vision (chrest:ListPattern.new 
				(list) 
				(chrest:Modality.value-of ("VISUAL"))
			)
			let episode-1-action (chrest:ListPattern.new 
				(list 
					(chrest:ItemSquarePattern.new (move-token) (0) (1))
					(chrest:ItemSquarePattern.new (move-token) (90) (1))
				)
				(chrest:Modality.value-of ("ACTION"))
			)
			let episode-1-time-generated (2000)
			add-episode-to-episodic-memory (episode-1-vision) (episode-1-action) (episode-1-time-generated)

			;;; EPISODE 2 ;;;

			let episode-2-vision (chrest:ListPattern.new 
				(list
					(chrest:ItemSquarePattern.new (tile-token) (0) (1))
					(chrest:ItemSquarePattern.new (hole-token) (1) (1))
				) 
				(chrest:Modality.value-of ("VISUAL"))
			)
			let episode-2-action (chrest:ListPattern.new 
				(list 
					(chrest:ItemSquarePattern.new (move-token) (270) (1))
					(chrest:ItemSquarePattern.new (move-token) (0) (1))
				)
				(chrest:Modality.value-of ("ACTION"))
			)
			let episode-2-time-generated (4000)
			add-episode-to-episodic-memory (episode-2-vision) (episode-2-action) (episode-2-time-generated)

			;;; EPISODE 3 ;;;

			let episode-3-vision (chrest:ListPattern.new 
				(list
					(chrest:ItemSquarePattern.new (tile-token) (1) (0))
					(chrest:ItemSquarePattern.new (hole-token) (2) (0))
				) 
				(chrest:Modality.value-of ("VISUAL"))
			)
			let episode-3-action (chrest:ListPattern.new 
				(list 
					(chrest:ItemSquarePattern.new (move-token) (270) (1))
					(chrest:ItemSquarePattern.new (move-token) (90) (1))
					(chrest:ItemSquarePattern.new (push-tile-token) (90) (1))
				)
				(chrest:Modality.value-of ("ACTION"))
			)
			let episode-3-time-generated (6000)
			add-episode-to-episodic-memory (episode-3-vision) (episode-3-action) (episode-3-time-generated)

			;======================;
			;== INVOKE PROCEDURE ==;
			;======================;

			set current-training-time (episode-3-time-generated)

			while[not learn-action-sequence-as-production?][
				learn-from-episodic-memory
				set current-training-time (current-training-time + 1)
			]

			;===========;
			;== TESTS ==;
			;===========;

			;Check variables altered during procedure

			check-equal (learn-episode-action?) (true) ("when checking the 'learn-episode-action?' variable")
			check-equal (learn-episode-vision?) (false) ("when checking the 'learn-episode-vision?' variable")
			check-equal (learn-episode-as-production?) (false) ("when checking the 'learn-episode-as-production?' variable")
			check-equal (episode-to-learn-from) (3) ("when checking the 'episode-to-learn-from' variable") 
			check-equal (learn-action-sequence?) (false) ("when checking the 'learn-action-sequence?' variable") 
			check-equal (learn-action-sequence-as-production?) (true) ("when checking the 'learn-action-sequence-as-production?' variable") 
			check-equal (reinforce-productions?) (false) ("when checking the 'reinforce-productions? ' variable") 
			check-equal (episode-to-reinforce) (-1) ("when checking the 'episode-to-reinforce' variable") 
			check-equal (learn-from-episodic-memory?) (true) ("when checking the 'learn-from-episodic-memory?' variable")

			;Check that the turtle has learned.  Note that there's no precise expected results
			;for the values of the turtle's attention and cognition clocks, simply checking that
			;the results are greater than their default value is good enough (CHREST already checks
			;that these clocks are set correctly in its own test suite).  The test does, however,
			;check that there are the required number of Nodes in visual and action LTM and the expected
			;number of productions.

			check-greater-than-or-equal-to 
				(chrest:get-attention-clock) 
				(0) 
				("when checking the turtle's attention clock")

			check-greater-than-or-equal-to 
				(chrest:get-cognition-clock) 
				(0) 
				("when checking the turtle's cognition clock")

			;The turtle will create 5 action nodes:
			;
			; - Node 1: 
			;   ~ Contents: <[MV 0 1]>
			;   ~ Image: <[MV 0 1][MV 90 1]>
			; 
			; - Node 2: 
			;   ~ Contents: <[MV 90 1]>
			;   ~ Image: <[]>
			;
			; - Node 3:
			;   ~ Contents: <[MV 270 1]>
			;   ~ Image: <[MV 270 1][MV 0 1][MV 270 1][MV 90 1][PT 90 1]>
			;
			; - Node 4 (child of Node 3):
			;   ~ Contents: <[MV 90 1]>
			;   ~ Image: <[MV 270 1][MV 90 1][PT 90 1]>
			;
			; - Node 5:
			;   ~ Contents: <[PT 90 1]>
			;   ~ Image: <[]>
			;
			; - Node 6: (child of Node 3):
			;   ~ Contents: <[MV 0 1]>
			;   ~ Image: <>

			check-equal
				(chrest:get-ltm-modality-size (chrest:Modality.value-of ("ACTION")) (chrest:get-cognition-clock))
				(5)
				("when checking the number of nodes in the turtle's action LTM")

			;The turtle will create 4 visual nodes, one for each distinct primitive 
			;in episode 1, 2 and 3's visions.

			check-equal
				(chrest:get-ltm-modality-size (chrest:Modality.value-of ("VISUAL")) (chrest:get-cognition-clock))
				(4)
				("when checking the number of nodes in the turtle's visual LTM")

			check-equal
				(chrest:get-production-count (chrest:get-cognition-clock))
				(2)
				("when checking the number of productions in the turtle's LTM")

			;Check that the visual Nodes and productions expected to be created have been and are 
			;present in visual STM.
			;
			;NOTE: Since episode 1's vision is empty, no check is made for a Node representing it 
			;      since one should never be created.  This is verified by the size of visual STM 
			;      check.

			let visual-stm-contents (chrest:Stm.get-contents (chrest:get-stm (chrest:Modality.value-of ("VISUAL"))) (chrest:get-cognition-clock))
			let visual-node-in-stm-with-image-equal-to-episode-3-vision (false)
			let episode-3-vision-contains-production-to-episode-3-action (false)
			foreach(visual-stm-contents)[
				let node-image-string (chrest:ListPattern.get-as-string (chrest:Node.get-image (?) (chrest:get-cognition-clock)))

				if(node-image-string = (chrest:ListPattern.get-as-string (episode-3-vision)))[
					set visual-node-in-stm-with-image-equal-to-episode-3-vision (true)

					let node-productions (chrest:Node.get-productions (?) (chrest:get-cognition-clock))
					foreach(node-productions)[
						let action-node-linked-to (item (0) (?))
						let action-node-linked-to-image-string (chrest:ListPattern.get-as-string (chrest:Node.get-image (action-node-linked-to) (chrest:get-cognition-clock)))
						if(action-node-linked-to-image-string = chrest:ListPattern.get-as-string (episode-3-action))[
							set episode-3-vision-contains-production-to-episode-3-action (true)
						]
					]
					
				]
			]

			check-equal 
				(length visual-stm-contents) 
				(2) 
				("occurred when checking the size of visual STM")

			check-equal 
				(visual-node-in-stm-with-image-equal-to-episode-3-vision) 
				(true) 
				("occurred when checking if a Node representing episode 3's vision is present in visual STM")

			check-equal 
				(episode-3-vision-contains-production-to-episode-3-action) 
				(true) 
				("occurred when checking if the production between episode 3's vision and action is present")

			;Check that the action Nodes expected to be created have been and are present in action STM.

			let action-stm-contents (chrest:Stm.get-contents (chrest:get-stm (chrest:Modality.value-of ("ACTION"))) (chrest:get-cognition-clock))
			let action-node-in-stm-with-image-equal-to-episode-3-action (false)
			let action-node-in-stm-with-image-equal-to-action-sequence (false)
			foreach(action-stm-contents)[
				let node-image-string (chrest:ListPattern.get-as-string (chrest:Node.get-image (?) (chrest:get-cognition-clock)))
				
				if(node-image-string = (chrest:ListPattern.get-as-string (episode-3-action)))[
					set action-node-in-stm-with-image-equal-to-episode-3-action (true)
				]
				if(node-image-string = (chrest:ListPattern.get-as-string (chrest:ListPattern.append (episode-2-action) (episode-3-action))))[
					set action-node-in-stm-with-image-equal-to-action-sequence (true)
				]
			]

			check-equal 
				(length action-stm-contents) 
				(3) 
				("occurred when checking the size of action STM")

			check-equal 
				(action-node-in-stm-with-image-equal-to-episode-3-action) 
				(true) 
				("occurred when checking if a Node representing episode 3's actions is present in action STM")

			check-equal 
				(action-node-in-stm-with-image-equal-to-action-sequence) 
				(true) 
				("occurred when checking if a Node representing the action sequence is present in action STM")
		]

		reset(true)
	]
</test>